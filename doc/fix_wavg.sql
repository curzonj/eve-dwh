update market_daily_stats s2 set
  day_buy_price_wavg_tx = ( select case sum(n2+n3) when 0 then NULL when null then null else sum(n1*(n2+n3)) / sum(n2+n3) end from ( select unnest(buy_price_wavg_sold) n1, unnest(buy_units_vol_chg) n2, unnest(buy_units_disappeared) n3 from market_daily_stats s1 where s1.date_of = s2.date_of and s1.type_id = s2.type_id and s1.region_id = s2.region_id and s1.station_id = s2.station_id ) a ),
  day_sell_price_wavg_tx = ( select case sum(n2+n3) when 0 then NULL when null then null else sum(n1*(n2+n3)) / sum(n2+n3) end from (select unnest(sell_price_wavg_sold) n1, unnest(sell_units_vol_chg) n2, unnest(sell_units_disappeared) n3 from market_daily_stats s1 where s1.date_of = s2.date_of and s1.type_id = s2.type_id and s1.region_id = s2.region_id and s1.station_id = s2.station_id) a);
